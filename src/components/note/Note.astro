---
import { Image, getImage } from "astro:assets";
import { type CollectionEntry, render } from "astro:content";
import FormattedDate from "@/components/FormattedDate.astro";
import { Icon } from "astro-icon/components";
import type { HTMLTag, Polymorphic } from "astro/types";

type Props<Tag extends HTMLTag> = Polymorphic<{ as: Tag }> & {
	note: CollectionEntry<"note">;
	isPreview?: boolean | undefined;
};

const { as: Tag = "div", note, isPreview = false } = Astro.props;
const { Content } = await render(note);
const coverImage = note.data.coverImage ? await getImage({ src: note.data.coverImage.src }) : null;
---

<article
	class:list={[
		isPreview && "inline-grid rounded-md bg-[rgb(240,240,240)] px-4 py-3 dark:bg-[rgb(33,35,38)]",
	]}
	data-pagefind-body={isPreview ? false : true}
>
	<Tag class="title" class:list={{ "text-base": isPreview }}>
		{
			isPreview ? (
				<a class="cactus-link" href={`/notes/${note.id}/`}>
					{note.data.title}
				</a>
			) : (
				<>{note.data.title}</>
			)
		}
	</Tag>
	<div class="mt-4 gap-4" class:list={{ flex: isPreview }}>
		<div
			class="prose prose-sm prose-cactus max-w-none [&>p:last-of-type]:mb-0"
			class:list={{ "line-clamp-6": isPreview, "flex-1": isPreview }}
		>
			<Content />
		</div>
		{
			note.data.coverImage?.src ? (
				isPreview ? (
					<div class="flex-shrink-0">
						<a href={coverImage?.src || ""} target="_blank" rel="noreferrer">
							<Image
								alt={note.data.coverImage.alt}
								class="object-cover"
								fetchpriority="high"
								loading="eager"
								src={note.data.coverImage.src}
								width={144}
							/>
						</a>
					</div>
				) : (
					<div>
						<Image
							alt={note.data.coverImage.alt}
							class="object-cover"
							fetchpriority="high"
							loading="eager"
							src={note.data.coverImage.src}
						/>
					</div>
				)
			) : null
		}
	</div>
	<div class="mt-3">
		<Icon aria-hidden="true" class="inline" focusable="false" name="mdi:calendar" />
		<a class="cactus-link" href={`/notes/${note.id}/`}>
			<FormattedDate date={note.data.publishDate} />
		</a>
	</div>
</article>
